#!/bin/sh

setpaper() {
	if [ "$QT_STYLE_OVERRIDE" == "Windows" ] || [ ! -f "$wallpaper" ]; then
		exit
	elif [ "$(theme)" == "dark" ]; then
		wal -ni "$wallpaper"
	else
		wal -lni "$wallpaper"
	fi
	cp "$wallpaper" "$paperfolder/wallpaper"
	convert "$paperfolder/wallpaper" -scale 2.5% -resize 4000% "$paperfolder/backdrop"
	if [ -n "$WAYLAND_DISPLAY" ]; then
		pkill hyprpaper
		hyprpaper &
		pkill swaybg
		swaybg -i "$paperfolder/backdrop" -m fill &
		cp ~/.cache/wal/colors-waybar.css ~/.config/waybar/
		makoctl reload
	elif [ -n "$DISPLAY" ]; then
		xwallpaper --zoom "$wallpaper"
		xdo key_press -k 133; xdo key_press -k 71; sleep 0.2; xdo key_release -k 71; xdo key_release -k 133
		mkdir -p ~/.config/dunst/dunstrc.d
		cp ~/.cache/wal/colors-dunst.conf ~/.config/dunst/dunstrc.d/
		dunstctl reload
	fi
	pywalfox update
	pgrep qutebrowser && qutebrowser :config-source
}

manual() {
	wallpaper="$arg"
	setpaper
}

picker() {
	wallpaper="$(nsxiv -ot $themefolder/* | shuf -n 1)"
	setpaper
}

random() {
	wallpaper="$(find $themefolder/* | shuf -n 1)"
	setpaper
}

weather() {
	wallpaper="$paperfolder/wallpaper"
	convert "$wallpaper" <( curl wttr.in/_tqp0.png ) -geometry +100+100 -composite "$wallpaper"
	setpaper
}

help() {
	echo "Usage: wallpaper [ARG]"
	echo "  directory/filename        set wallpaper manually"
	echo "  picker                    choose from a picker"
	echo "  random                    random picture"
	echo "  weather                   overlay weather forecast"
	echo "  help                      display help"
}

paperfolder="$HOME/Pictures/wallpapers"
themefolder="$paperfolder/$(theme)"
arg=${1:-help}

case "$arg" in
	picker|random|weather|help ) $arg ;;
	*                          ) manual ;;
esac
