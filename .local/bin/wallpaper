#!/bin/sh

setfolder() {
	if [ -f ~/.config/dark ]; then
		theme=dark
	else
		theme=light
	fi
	folder=~/Pictures/wallpapers/$theme
	mkdir -p $folder
}

setpaper() {
	if [ "$QT_STYLE_OVERRIDE" == "Windows" ] || [ "$wallpaper" == "" ]; then
		exit
	fi
	wallpaper="~/Pictures/wallpapers/wallpaper"
	wal -n -i "$wallpaper"
	source ~/.cache/wal/colors.sh
	if [ -n "$WAYLAND_DISPLAY" ]; then
		hyprctl hyprpaper reload ,"$wallpaper"
		sed -i "s/background-color=.*/background-color=${color0}dd/" "$HOME/.config/mako/config"
		sed -i "s/border-color=.*/border-color=${color3}dd/" "$HOME/.config/mako/config"
		sed -i "s/text-color=.*/text-color=${color7}dd/" "$HOME/.config/mako/config"
		sed -i "s/progress-color=.*/progress-color=${color7}dd/" "$HOME/.config/mako/config"
		makoctl reload
	elif [ -n "$DISPLAY" ]; then
		xwallpaper --zoom "$wallpaper"
		xdo key_press -k 133; xdo key_press -k 71; sleep 0.2; xdo key_release -k 71; xdo key_release -k 133
		sed -i '/background = /s/.*/background = "'$color0'"/' "$HOME/.config/dunst/dunstrc"
		sed -i '/foreground = /s/.*/foreground = "'$color7'"/' "$HOME/.config/dunst/dunstrc"
		sed -i '/frame_color = /s/.*/frame_color = "'$color3'"/' "$HOME/.config/dunst/dunstrc"
		killall dunst && dunst &
	fi
	pgrep qutebrowser && qutebrowser ":config-source"
}

manual() {
	if [ -f "$arg" ]; then
		setfolder
		cp "$arg" ~/Pictures/wallpapers/wallpaper
		setpaper
	else
		echo "File not found"
	fi
}

picker() {
	setfolder
	cp "$(nsxiv -ot $folder/* | shuf -n 1)" ~/Pictures/wallpapers/wallpaper
	setpaper
}

random() {
	setfolder
	cp "$(find $folder/* | shuf -n 1)" ~/Pictures/wallpapers/wallpaper
	setpaper
}

weather() {
	convert ~/Pictures/wallpapers/wallpaper <( curl wttr.in/_tqp0.png ) -geometry +100+100 -composite ~/Pictures/wallpapers/wallpaper
	setpaper
}

help() {
	echo "Usage: wallpaper [ARG]"
	echo "  directory/filename        set wallpaper manually"
	echo "  picker                    choose from a picker"
	echo "  random                    random picture"
	echo "  weather                   overlay weather forecast"
}

arg=${1:-help}
case "$arg" in
	help|picker|random|weather ) $arg ;;
	*                          ) manual ;;
esac
