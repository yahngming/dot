#!/bin/sh

setpaper() {
	if [ "$QT_STYLE_OVERRIDE" == "Windows" ] || [ "$wallpaper" == "" ]; then
		exit
	fi
	cp "$wallpaper" "$paperfolder/wallpaper"
	convert "$paperfolder/wallpaper" -scale 2.5% -resize 4000% "$paperfolder/backdrop"
	wal -n -i "$wallpaper"
	source ~/.cache/wal/colors.sh
	if [ -n "$WAYLAND_DISPLAY" ]; then
		pkill hyprpaper
		pkill swaybg
		hyprpaper &
		swaybg -i "$paperfolder/backdrop" -m fill &
		cp ~/.cache/wal/colors-waybar.css ~/.config/waybar/
		sed -i "s/background-color=.*/background-color=${color0}dd/" "$HOME/.config/mako/config"
		sed -i "s/border-color=.*/border-color=${color3}dd/" "$HOME/.config/mako/config"
		sed -i "s/text-color=.*/text-color=${color7}dd/" "$HOME/.config/mako/config"
		sed -i "s/progress-color=.*/progress-color=${color7}dd/" "$HOME/.config/mako/config"
		makoctl reload
	elif [ -n "$DISPLAY" ]; then
		xwallpaper --zoom "$wallpaper"
		xdo key_press -k 133; xdo key_press -k 71; sleep 0.2; xdo key_release -k 71; xdo key_release -k 133
		sed -i '/background = /s/.*/background = "'$color0'"/' "$HOME/.config/dunst/dunstrc"
		sed -i '/foreground = /s/.*/foreground = "'$color7'"/' "$HOME/.config/dunst/dunstrc"
		sed -i '/frame_color = /s/.*/frame_color = "'$color3'"/' "$HOME/.config/dunst/dunstrc"
		pkill dunst
		dunst &
	fi
	pgrep qutebrowser && qutebrowser :config-source
}

manual() {
	if [ -f "$arg" ]; then
		wallpaper="$arg"
		setpaper
	else
		echo "File not found"
	fi
}

picker() {
	wallpaper="$(nsxiv -ot $themefolder/* | shuf -n 1)"
	setpaper
}

random() {
	wallpaper="$(find $themefolder/* | shuf -n 1)"
	setpaper
}

weather() {
	wallpaper="$paperfolder/wallpaper"
	convert "$wallpaper" <( curl wttr.in/_tqp0.png ) -geometry +100+100 -composite "$wallpaper"
	setpaper
}

help() {
	echo "Usage: wallpaper [ARG]"
	echo "  directory/filename        set wallpaper manually"
	echo "  picker                    choose from a picker"
	echo "  random                    random picture"
	echo "  weather                   overlay weather forecast"
}

if [ -f ~/.config/dark ]; then
	theme=dark
else
	theme=light
fi
paperfolder="$HOME/Pictures/wallpapers"
themefolder="$paperfolder/$theme"
arg=${1:-help}

case "$arg" in
	help|picker|random|weather ) $arg ;;
	*                          ) manual ;;
esac
