#!/bin/sh

primary() {
	if [ -n "$WAYLAND_DISPLAY" ]; then
		monitors=$(wlr-randr | grep "^[^ ]" | sed 's/^[^"]*"//' | sed 's/"$//')
		outputs=$(echo "$monitors" | awk '{print $NF}')
		primary=$(echo "$monitors" | menu -p "Select primary display:" | awk '{print $NF}')
		wlr-randr --output "$primary" --on --preferred --pos 0,0
		pkill wl-mirror
	elif [ -n "$DISPLAY" ]; then
		monitors=$(xrandr -q | grep "connected")
		outputs=$(echo "$monitors" | awk '/ connected/ {print $1}')
		primary=$(echo "$monitors" | menu -p "Select primary display:" | awk '/ connected/ {print $1}')
		xrandr --output "$primary" --auto
	fi
}

extend() {
	primary
	if [ -n "$WAYLAND_DISPLAY" ]; then
		for output in $outputs; do
			if [ "$output" != "$primary" ]; then
				wlr-randr --output "$output" --on --preferred
			fi
		done
	elif [ -n "$DISPLAY" ]; then
		secondary=$(echo "$outputs" | grep -v ^"$primary"$ | menu -p "Select secondary display:")
		tertiary=$(echo "$outputs" | grep -v ^"$primary"$ | grep -v ^"$secondary"$ | menu -p "Select third display:")
		direction=$(printf "left\\nright" | menu -p "$secondary is on the:")
		xrandr --output "$secondary" --"$direction"-of "$primary" --auto --output "$tertiary" --"$(printf "left\\nright" | grep -v "$direction")"-of "$primary" --auto
	fi
}

mirror() {
	primary
	if [ -n "$WAYLAND_DISPLAY" ]; then
		for output in $outputs; do
			if [ "$output" != "$primary" ]; then
				wlr-randr --output "$output" --on --preferred
				wl-mirror --fullscreen-output "$output" "$primary"
			fi
		done
	elif [ -n "$DISPLAY" ]; then
		secondary=$(echo "$outputs" | grep -v "$primary")
		res_primary=$(xrandr --query | sed -n "/^$primary/,/\+/p" | tail -n 1 | awk '{print $1}')
		res_secondary=$(xrandr --query | sed -n "/^$secondary/,/\+/p" | tail -n 1 | awk '{print $1}')
		res_ext_x=$(echo "$res_primary" | sed 's/x.*//')
		res_ext_y=$(echo "$res_primary" | sed 's/.*x//')
		res_int_x=$(echo "$res_secondary" | sed 's/x.*//')
		res_int_y=$(echo "$res_secondary" | sed 's/.*x//')
		scale_x=$(echo "$res_ext_x / $res_int_x" | bc -l)
		scale_y=$(echo "$res_ext_y / $res_int_y" | bc -l)
		xrandr --output "$secondary" --auto --same-as "$primary" --scale "$scale_x"x"$scale_y"
	fi
}

single() {
	primary
	if [ -n "$WAYLAND_DISPLAY" ]; then
		for output in $outputs; do
			if [ "$output" != "$primary" ]; then
				wlr-randr --output "$output" --off
			fi
		done
	elif [ -n "$DISPLAY" ]; then
		xrandr $(echo "$outputs" | grep -v "\b$primary" | awk '{print "--output", $primary, "--off"}' | paste -sd ' ' -)
	fi
}

menu="\
󰹑 Extend monitors\n\
󰍺 Mirror monitors\n\
󰍹 Single monitor\n\
"

case $(printf "$menu" | menu -p "Display" "$@") in
	*Extend* ) extend ;;
	*Mirror* ) mirror ;;
	*Single* ) single ;;
esac
