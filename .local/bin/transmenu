#!/bin/sh

pkill $LAUNCHER && exit

load_config() {
	if [ -n "$WAYLAND_DISPLAY" ]; then
		: "${CLIP_COPY:=wl-copy -n}"
		: "${CLIP_PASTE_CLIP:=wl-paste}"
		: "${CLIP_PASTE_PRIM:=wl-paste -p}"
	else
		: "${CLIP_COPY:=xclip -i -r -selection clipboard}"
		: "${CLIP_PASTE_CLIP:=xclip -o -selection clipboard}"
		: "${CLIP_PASTE_PRIM:=xclip -o -selection primary}"
	fi
	: "${TRANS_ENGINE:=google}"
	: "${TRANS_LANGS:=:zh :en :ja}"
}

formatmenu() {
	echo "$1" | tr '\n' '  ' | sed 's/\s\{3,\}//g; s/^\(.\{30\}\).\+/\1.../; s/$/\n/'
}

get_selection() {
	[ -n "$1" ] && eval "$CLIP_PASTE_CLIP" || eval "$CLIP_PASTE_PRIM"
}

clip_menu() {
	{ formatmenu "$1"; formatmenu "$2"; } |
		sed 's/^\s*$//; 1s/^./Primary: &/; 2s/^./Clipboard: &/' |
		sed '/^$/d'
}

lang_menu() {
	echo "$TRANS_LANGS" | sed 's/\s\+/\n/g' | sed '/:/!s/^/:/'
	echo ":define"
}

save_file() (
	tmp="$(mktemp --tmpdir 'transmenu.XXXXXX')"
	echo "$1" > "$tmp"
	echo "$tmp"
)

open_term() {
	tui "bat --paging always -pl man '$(save_file "$1")'"
}

get_text() {
	echo "$2" | while IFS= read -r clip; do
	[ "$1" = "$clip" ] && {
		type="$(echo "$clip" | sed 's/^\(\w\+\):.*/\1/')"
			case "$type" in
				Primary)   echo "$primary"   ;;
				Clipboard) echo "$clipboard" ;;
			esac
			exit 10
		}
	done
	[ $? -ne 10 ] && echo "$1"
}

load_config

primary="$(get_selection)"
clipboard="$(get_selection clip)"
clip_menu="$(clip_menu "$primary" "$clipboard")"
text="$(printf '%s' "$clip_menu" | eval "menu -p 'Translate:'" '$@')" || exit 0
text="$(get_text "$text" "$clip_menu")"
target="$(lang_menu | eval "menu -p 'Into:'" '$@')" || exit 0

if [ "$target" = ":define" ]; then
	open_term "$(trans -dictionary "$text")"
else
	open_term "$(trans -e "$TRANS_ENGINE" "$target" "$text")"
fi
